# 开发日志 (Changelog)

本文档记录 Cyber-Werewolf 项目的所有重要变更。

## [0.3.0] - 2024-12-29

### 🎯 角色能力完整实现

#### 新增功能
- **预言家（Seer）能力实现** (`src/agents/roles/seer.py`)
  - 实现 `check_player` 方法：查验玩家身份
  - 查验结果保存在 `seer_checks` 中
  - 在夜晚阶段调用 Agent 决定查验目标
  - 支持查验历史记录

- **女巫（Witch）能力实现** (`src/agents/roles/witch.py`)
  - 实现 `decide_antidote` 方法：决定是否使用解药救人
  - 实现 `decide_poison` 方法：决定是否使用毒药（不能给自己用）
  - 跟踪解药和毒药的使用状态（`antidote_used`、`poison_used`）
  - 支持第一夜自救逻辑
  - 在夜晚阶段调用 Agent 决定使用解药或毒药

- **守卫（Guard）能力实现** (`src/agents/roles/guard.py`)
  - 实现 `decide_protect` 方法：决定守护哪个玩家
  - 限制：不能连续两晚守护同一人
  - 在夜晚阶段调用 Agent 决定守护目标
  - 守卫效果可以抵消狼人攻击（在夜晚结果处理中实现）

- **狼人（Werewolf）特殊能力实现** (`src/agents/werewolf.py`)
  - **天黑发言**：实现 `discuss_in_werewolf_channel` 方法
    - 狼人可以在狼人频道讨论策略
    - 发言记录保存在 `werewolf_channel` 中
  - **投票杀人**：实现 `vote_to_kill` 方法
    - 每个狼人独立投票决定攻击目标
    - 得票最多的玩家被攻击，平票则平安夜
  - **自爆**：实现 `decide_self_explode` 方法
    - 狼人可以在发言阶段自爆
    - 自爆后立即出局，终止发言，直接进入黑夜

- **Agent 工厂** (`src/utils/agent_factory.py`)
  - 实现 `create_agent_by_role`：根据角色创建对应的 Agent
  - 实现 `create_agents_from_players`：从玩家列表批量创建 Agent
  - 支持所有角色类型（村民、狼人、预言家、女巫、守卫）

#### 改进
- **夜晚阶段完整集成** (`src/graph/nodes.py`)
  - 按顺序执行：狼人攻击 → 预言家查验 → 守卫守护 → 女巫解药/毒药
  - 正确处理守卫守护效果（抵消狼人攻击）
  - 正确处理女巫解药和毒药效果
  - 更新游戏状态（技能使用状态、查验历史、狼人频道）

- **发言阶段增强** (`src/graph/nodes.py`)
  - 集成狼人自爆检测
  - 自爆后立即更新玩家状态
  - 支持自爆后直接进入黑夜的路由

- **游戏图路由优化** (`src/graph/game_graph.py`)
  - 新增 `route_after_discussion` 函数
  - 检查自爆状态，如有自爆则直接进入黑夜
  - 完善游戏流程控制

- **行动类型扩展** (`src/schemas/actions.py`)
  - 新增 `explode` 行动类型，支持自爆操作

#### 技术细节
- 所有角色能力都通过 Agent 调用，便于后续集成 LLM 决策
- 实现了完整的技能使用状态跟踪
- 支持技能间的交互（如守卫抵消狼人攻击）
- 完善了游戏状态管理，支持所有角色特殊能力

---

## [0.2.2] - 2024-12-29

### 🎮 游戏流程优化

#### 修改
- **第一天流程调整**：先进行警长竞选和投票，再公布出局玩家
- **警长机制完善**：
  - 全部玩家上警：本局失去警徽，没有警长
  - 退水操作：警上玩家可以在发言过程中退出竞选
  - 警长投票平票：第一轮平票→PK发言→第二轮投票
  - 第二轮依然平票：本局没有警长，警徽流失

#### 修复
- **女巫毒药**：毒药不能给自己用
- **文档调整**：警长相关内容不再放在预言家下面

#### 改进
- 优化警长投票平票处理流程
- 完善状态管理，支持警长投票轮次和平票候选人

---

## [0.2.1] - 2024-12-29

### 🧹 代码清理

#### 删除
- 移除 V1 版本代码（`game_graph.py` V1, `nodes.py` V1）
- 删除 `examples/demo_game.py`（V1 演示）
- 清理所有 V1/V2 版本引用

#### 重构
- 将 V2 版本代码重命名为主版本
  - `game_graph_v2.py` → `game_graph.py`
  - `nodes_v2.py` → `nodes.py`
- 统一函数命名（移除 `_v2` 后缀）
- 更新所有文档，移除版本区分说明

#### 改进
- 简化项目结构，只保留完整版本
- 更新所有文档引用
- 优化代码组织

---

## [0.2.0] - 2024-12-29

### 🎮 完整游戏流程实现

#### 新增功能
- **身份分配系统** (`src/utils/role_assigner.py`)
  - 随机分配身份功能
  - 支持自动配置（根据玩家数量）
  - 支持自定义角色配置

- **完整游戏流程** (`src/graph/nodes.py`, `src/graph/game_graph.py`)
  - 夜晚阶段：狼人、预言家、守卫、女巫按顺序行动
  - 警长竞选和投票机制
  - 发言阶段（支持自爆、警长选择顺序）
  - 放逐投票（支持平票重议）
  - 屠边规则判定

- **状态管理扩展** (`src/state/game_state.py`)
  - 新增警长相关字段（`sheriff_candidates`, `sheriff_votes`）
  - 新增角色技能字段（`seer_checks`, `witch_antidote_used`, `witch_poison_used`, `guard_protected`）
  - 新增自爆和遗言字段（`self_exploded`, `last_words`）

- **游戏规则文档** (`docs/GAME_RULES.md`)
  - 详细的游戏规则说明
  - 角色能力说明
  - 实现状态说明

#### 改进
- 优化平票检测机制：第一轮平票→重议，第二轮平票→直接黑夜
- 完善警长机制：支持竞选、投票、选择发言顺序、自爆

#### 技术细节
- 使用 LangGraph 实现完整游戏工作流
- 支持条件边路由（游戏结束、平票、阶段切换）
- 实现熔断机制防止死循环

---

## [0.1.1] - 2024-12-29

### 🔧 平票机制和警长功能

#### 新增功能
- **平票重议机制**
  - 第一轮投票平票：平票玩家进行第二轮发言和投票
  - 第二轮依然平票：直接进入黑夜，无人出局

- **警长机制**
  - 玩家模型新增 `is_sheriff` 字段
  - 第一天警长竞选节点
  - 警长投票功能
  - Demo 中显示警长信息

#### 改进
- 更新 `GameState` 支持平票重议相关字段
- 优化投票节点支持平票处理
- 更新工作流图支持警长竞选流程

---

## [0.1.0] - 2024-12-29

### 🚀 初始版本

#### 核心功能
- **项目结构搭建**
  - 完整的模块化项目结构
  - 源代码、测试、示例、文档分离

- **LangGraph 工作流实现**
  - 游戏初始化节点
  - 发言阶段节点
  - 投票阶段节点
  - 夜晚行动节点
  - 结果判定节点
  - 状态检查节点（熔断机制）

- **状态管理系统**
  - `GameState` TypedDict 定义
  - `StateManager` 状态管理器
  - 支持投票、发言、历史记录

- **Agent 框架**
  - `BaseAgent` 抽象基类
  - `VillagerAgent` 村民实现
  - `WerewolfAgent` 狼人实现
  - 支持观察、推理、行动接口

- **记忆系统**
  - 三级记忆系统（PUBLIC/ROLE/PRIVATE）
  - 信息过滤函数防止信息泄露

- **结构化输出**
  - `AgentAction` Pydantic Schema
  - 支持重试机制

- **LLM 客户端**
  - 支持 DeepSeek-V3 API（默认）
  - 支持 OpenAI API（备选）
  - 结构化输出支持

#### 文档
- README.md - 项目说明
- docs/LLM_CONFIG.md - LLM 配置说明
- docs/QUICKSTART.md - 快速开始指南
- docs/GRAPH_IMPLEMENTATION.md - 工作流实现说明

#### 测试
- 基础测试用例
- 示例代码（demo_game.py, test_deepseek.py）

---

## 版本说明

- **主版本号**：重大架构变更
- **次版本号**：新功能添加
- **修订版本号**：Bug 修复和小改进

## 未来计划

### v0.3.1 (计划中)
- [ ] Agent 完整集成（LLM 调用）
  - 预言家查验决策（LLM）
  - 女巫解药/毒药决策（LLM）
  - 守卫守护决策（LLM）
  - 狼人攻击决策（LLM）
  - 狼人频道发言生成（LLM）
  - 自爆决策（LLM）
- [ ] 完整的发言系统（LLM 生成发言内容）
- [ ] 完整的投票决策（LLM 决策）
- [ ] 警长移交机制
- [ ] 遗言系统

### v0.4.0 (计划中)
- [ ] 性能优化
- [ ] 多局游戏支持
- [ ] 游戏回放功能
- [ ] 策略分析工具

