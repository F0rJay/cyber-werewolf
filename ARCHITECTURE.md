# 架构设计文档

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────┐
│           LangGraph 工作流引擎                  │
│  (game_graph.py - 完整游戏流程)                 │
└─────────────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│  节点层   │ │  状态层   │ │  Agent层  │
│ (nodes)   │ │ (state)   │ │ (agents)  │
└───────────┘ └───────────┘ └───────────┘
        │           │           │
        └───────────┼───────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────┐         ┌───────────┐
│  记忆系统  │         │  LLM 客户端│
│ (memory)  │         │ (utils)   │
└───────────┘         └───────────┘
```

## 核心组件

### 1. LangGraph 工作流层

**职责**: 定义游戏流程，管理节点和边的流转

**关键文件**:
- `src/graph/game_graph.py`: 主工作流图
- `src/graph/nodes.py`: 所有节点实现
- `src/graph/edges.py`: 条件边实现

**设计模式**: 
- 状态机模式
- 条件路由模式

### 2. 状态管理层

**职责**: 管理游戏全局状态

**关键文件**:
- `src/state/game_state.py`: 状态定义和管理

**设计特点**:
- 使用 TypedDict 定义状态结构
- 不可变更新（通过创建新对象）
- 完整的历史记录

### 3. Agent 层

**职责**: 实现各角色的智能体

**关键文件**:
- `src/agents/base_agent.py`: Agent 基类
- `src/agents/*.py`: 各角色实现

**设计模式**:
- 策略模式（不同角色不同策略）
- 模板方法模式（observe → think → act）

### 4. 记忆系统

**职责**: 管理分级记忆，防止信息泄露

**关键文件**:
- `src/memory/memory_manager.py`: 记忆管理器
- `src/memory/filters.py`: 信息过滤

**设计特点**:
- 三级记忆系统（PUBLIC/ROLE/PRIVATE）
- 基于角色的信息过滤

### 5. LLM 集成层

**职责**: 封装 LLM 调用

**关键文件**:
- `src/utils/llm_client.py`: LLM 客户端

**设计特点**:
- 支持多 LLM 提供商（DeepSeek/OpenAI）
- 结构化输出支持
- 错误处理和重试

## 数据流

### 游戏流程数据流

```
初始化 → 身份分配 → 夜晚阶段
                          ↓
                    公布出局玩家
                          ↓
                    警长竞选（第一天）
                          ↓
                    发言阶段
                          ↓
                    放逐投票
                          ↓
                    结果判定
```

### Agent 决策数据流

```
GameState → observe() → Observation
                              ↓
                         think() → Thought
                              ↓
                         act() → AgentAction
                              ↓
                        更新 GameState
```

## 设计原则

1. **单一职责**: 每个模块只负责一个功能
2. **开闭原则**: 对扩展开放，对修改关闭
3. **依赖倒置**: 依赖抽象而非具体实现
4. **接口隔离**: 使用小接口而非大接口

## 扩展点

1. **新角色**: 继承 `BaseAgent`，实现三个方法
2. **新节点**: 在 `nodes.py` 添加函数，在 `game_graph.py` 注册
3. **新技能**: 在相应节点中实现，更新 `GameState`
4. **新 LLM**: 在 `llm_client.py` 添加支持

